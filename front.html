<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crop Predictor — Frontend</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#7dd3fc; --muted:#94a3b8; --ok:#16a34a; --err:#ef4444;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%, #071726 100%);color:#e6eef8}
    .wrap{max-width:920px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .badge{display:inline-flex;align-items:center;gap:8px;font-size:13px;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted)}
    .indicator{width:10px;height:10px;border-radius:50%}
    .indicator.ok{background:var(--ok)} .indicator.err{background:var(--err)} .indicator.loading{background:var(--muted)}
    main{display:grid;grid-template-columns:1fr 420px;gap:18px}
    form{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    label{font-size:13px;color:var(--muted);margin-bottom:6px}
    input, select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    button{background:linear-gradient(90deg,var(--accent),#60a5fa);border:none;padding:10px 14px;border-radius:10px;color:#042733;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .results{background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;height:100%;overflow:auto}
    pre{white-space:pre-wrap;word-break:break-word;font-size:13px}
    .meta{font-size:13px;color:var(--muted);margin-top:10px}
    .row{display:flex;gap:8px;align-items:center}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    .small{font-size:12px;color:var(--muted)}
    .loader{width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{background:rgba(255,0,0,0.04);border:1px solid rgba(255,0,0,0.08);padding:8px;border-radius:8px;color:var(--err);margin-bottom:10px}
    .success{background:rgba(0,255,0,0.03);border:1px solid rgba(0,255,0,0.06);padding:8px;border-radius:8px;color:var(--ok);margin-bottom:10px}
    @media (max-width:880px){main{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Crop Predictor</h1>
      <div style="flex:1"></div>
      <div class="badge" id="healthBadge">
        <span id="healthInd" class="indicator loading"></span>
        <span id="healthTxt">Checking backend...</span>
      </div>
    </header>

    <main>
      <form id="predictForm" autocomplete="off" onsubmit="return false;">
        <div id="statusArea"></div>

        <div class="grid2">
          <div class="field">
            <label for="N">Nitrogen (N)</label>
            <input id="N" type="number" step="any" value="50"/>
          </div>
          <div class="field">
            <label for="P">Phosphorus (P)</label>
            <input id="P" type="number" step="any" value="20"/>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="K">Potassium (K)</label>
            <input id="K" type="number" step="any" value="30"/>
          </div>
          <div class="field">
            <label for="SOWN">SOWN (month number 1-12)</label>
            <input id="SOWN" type="number" step="1" min="1" max="12" value="6"/>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="SOIL_PH">Soil pH</label>
            <input id="SOIL_PH" type="number" step="any" value="6.7"/>
          </div>
          <div class="field">
            <label for="TEMP">Temperature (°C)</label>
            <input id="TEMP" type="number" step="any" value="28"/>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label for="RELATIVE_HUMIDITY">Relative Humidity %</label>
            <input id="RELATIVE_HUMIDITY" type="number" step="any" value="70"/>
          </div>
          <div class="field">
            <label for="SOIL">Soil type</label>
            <input id="SOIL" type="text" value="loam"/>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="submitBtn" type="submit">Predict</button>
          <button id="checkBtn" class="secondary" type="button">Check backend</button>
          <button id="clearBtn" class="secondary" type="button">Clear</button>
        </div>

        <div class="meta small" style="margin-top:12px">
          This UI sends inputs only to your backend API: <span id="apiUrl" style="color:var(--accent)"></span>
        </div>
      </form>

      <div class="results" id="resultsPanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Prediction output</strong>
          <div class="row">
            <button id="copyJson" class="secondary" title="Copy JSON">Copy</button>
            <button id="downloadJson" class="secondary" title="Download JSON">Download</button>
          </div>
        </div>

        <div id="resultMsg" style="margin-top:12px"></div>
        <pre id="resultJson" style="margin-top:8px">No prediction yet.</pre>
      </div>
    </main>

    <footer>
      <div class="small">Made to fetch only from your backend API. Keep this page hosted wherever you like.</div>
    </footer>
  </div>

  <script>
    // ---------- CONFIG ----------
    const API_BASE = "https://crop-ashna-new.onrender.com"; // your API base
    const HEALTH_URL = API_BASE + "/api/health/";
    const PREDICT_URL = API_BASE + "/api/predict/";
    const HEALTH_POLL_MS = 30000; // 30s

    // ---------- UI helpers ----------
    const healthInd = document.getElementById("healthInd");
    const healthTxt = document.getElementById("healthTxt");
    const apiUrlEl = document.getElementById("apiUrl");
    apiUrlEl.textContent = PREDICT_URL;

    const resultJsonEl = document.getElementById("resultJson");
    const resultMsgEl = document.getElementById("resultMsg");
    const statusArea = document.getElementById("statusArea");

    function setHealth(status, message = "") {
      healthInd.className = "indicator " + (status === "ok" ? "ok" : status === "loading" ? "loading" : "err");
      healthTxt.textContent = message || (status === "ok" ? "Backend online" : status === "loading" ? "Checking..." : "Backend offline");
    }

    async function checkHealth(showToast = false) {
      setHealth("loading", "Checking backend...");
      try {
        const r = await fetch(HEALTH_URL, { method: "GET", cache: "no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const js = await r.json();
        setHealth("ok", "Backend online");
        if (showToast) showStatus("Connected to backend", "success");
        return { ok: true, data: js };
      } catch (err) {
        setHealth("err", "Backend unreachable");
        if (showToast) showStatus("Backend unreachable: " + err.message, "error");
        return { ok: false, error: err };
      }
    }

    function showStatus(msg, kind="info") {
      statusArea.innerHTML = "";
      const div = document.createElement("div");
      div.textContent = msg;
      div.style.marginBottom = "10px";
      if (kind === "error") div.className = "error";
      if (kind === "success") div.className = "success";
      statusArea.appendChild(div);
      setTimeout(()=> { if (statusArea.contains(div)) statusArea.removeChild(div); }, 4000);
    }

    function getFormValues() {
      return {
        N: Number(document.getElementById("N").value),
        P: Number(document.getElementById("P").value),
        K: Number(document.getElementById("K").value),
        SOWN: Number(document.getElementById("SOWN").value),
        SOIL_PH: Number(document.getElementById("SOIL_PH").value),
        TEMP: Number(document.getElementById("TEMP").value),
        RELATIVE_HUMIDITY: Number(document.getElementById("RELATIVE_HUMIDITY").value),
        SOIL: String(document.getElementById("SOIL").value).trim()
      };
    }

    function validate(inputs) {
      // minimal sanity checks (API will enforce/ clamp more strictly)
      if (!inputs.SOIL) return "Soil type is required";
      if (Number.isNaN(inputs.N) || Number.isNaN(inputs.P) || Number.isNaN(inputs.K)) return "N/P/K must be numbers";
      if (inputs.SOWN < 1 || inputs.SOWN > 12) return "SOWN must be month 1-12";
      return null;
    }

    function renderResult(obj) {
      resultJsonEl.textContent = JSON.stringify(obj, null, 2);
      resultMsgEl.innerHTML = "";
      if (obj.meta && obj.meta.was_clamped) {
        const d = document.createElement("div");
        d.className = "small";
        d.textContent = "Note: some inputs were clamped to training ranges. See meta.clamped_fields.";
        resultMsgEl.appendChild(d);
      }
    }

    // ---------- Predict ----------
    document.getElementById("submitBtn").addEventListener("click", async () => {
      statusArea.innerHTML = "";
      resultJsonEl.textContent = "Loading...";
      const inputs = getFormValues();
      const err = validate(inputs);
      if (err) { showStatus(err, "error"); resultJsonEl.textContent = "No prediction."; return; }

      // POST to backend only
      try {
        document.getElementById("submitBtn").disabled = true;
        document.getElementById("submitBtn").textContent = "Predicting...";
        const resp = await fetch(PREDICT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(inputs),
          cache: "no-store"
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error("HTTP " + resp.status + ": " + text);
        }
        const data = await resp.json();
        renderResult(data);
        showStatus("Prediction received", "success");
      } catch (e) {
        resultJsonEl.textContent = "Error — no prediction.";
        showStatus("Prediction failed: " + e.message, "error");
      } finally {
        document.getElementById("submitBtn").disabled = false;
        document.getElementById("submitBtn").textContent = "Predict";
      }
    });

    // ---------- copy / download ----------
    document.getElementById("copyJson").addEventListener("click", () => {
      const txt = resultJsonEl.textContent;
      if (!txt || txt === "No prediction yet." || txt.startsWith("Error")) return showStatus("No JSON to copy", "error");
      navigator.clipboard.writeText(txt).then(()=> showStatus("JSON copied", "success"), ()=> showStatus("Copy failed", "error"));
    });

    document.getElementById("downloadJson").addEventListener("click", () => {
      const txt = resultJsonEl.textContent;
      if (!txt || txt === "No prediction yet." || txt.startsWith("Error")) return showStatus("No JSON to download", "error");
      const blob = new Blob([txt], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "prediction.json"; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url); showStatus("Download started", "success");
    });

    // ---------- check backend button ----------
    document.getElementById("checkBtn").addEventListener("click", () => checkHealth(true));
    document.getElementById("clearBtn").addEventListener("click", () => {
      resultJsonEl.textContent = "No prediction yet.";
      statusArea.innerHTML = "";
    });

    // ---------- initial health check + poll ----------
    (async function init() {
      await checkHealth(false);
      setInterval(()=> checkHealth(false), HEALTH_POLL_MS);
    })();

  </script>
</body>
</html>
